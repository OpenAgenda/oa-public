import fs from 'node:fs';
import PDFDocument from 'pdfkit';
import addPageColumns from '../lib/addPageColumns.js';
import addFooter from '../lib/addFooter.js';
import getIntl from '../../utils/intl.js';
import messages from '../lib/messages.js';
import content from './fixtures/data.json' assert { type: 'json' };

const { PDF_TEST_FOLDER: pdfTestFolder = '/tmp' } = process.env;

const doc = new PDFDocument({ size: 'A4', margin: 0 });
const writeStream = fs.createWriteStream(`${pdfTestFolder}/addNewPage.pdf`);
doc.pipe(writeStream);

const lang = "fr";
const intl = getIntl(lang);

const cursor = { x: 0, y: 0 };
const margin = 20;

let pageNumber = 1;

const eventData = {
  title: 'Sample Title',
  description: { fr: 'Description en franÃ§ais' },
  image: {
    filename: "347c52b650d84e8aad815ac8afbc7472.base.image.jpg",
  }
};
const pageWidth = doc.page.width;

const pdfRender = (data) => ({
  columns: [{
    width: 2,
    content: [{
      addFn: 'addText',
      data: data.title,
      bold: true,
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }]
  }, {
    width: 2,
    content: [{
      addFn: 'addText',
      data: data.title,
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }, {
      addFn: 'addText',
      data: data.description.fr
    }]
  }, {
    width: 2,
    content: [{
      addFn: 'imagePositioning',
      data: data.image
    }, {
      addFn: 'addText',
      data: content.text,
      truncable: true,
    }]
  }]
});


const columnConfig = pdfRender(eventData);

let columnsWithContent;

addFooter(doc, `${intl.formatMessage(messages.page)} ${pageNumber}`, margin);

columnsWithContent = await addPageColumns({ doc, cursor }, columnConfig, { pageWidth });

while (columnsWithContent.some(column => column.content.length > 0)) {
  doc.addPage();
  columnsWithContent = await addPageColumns({ doc, cursor }, { columns: columnsWithContent }, { pageWidth }); 
  pageNumber += 1;
  addFooter(doc, `${intl.formatMessage(messages.page)} ${pageNumber}`, margin);
}

doc.end();
