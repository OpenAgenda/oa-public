{"version":3,"file":"utils.js","names":["_objectSpread","require","default","_","get","pick","isArray","withFieldValueMatches","module","exports","registerValidators","mapValuesToValidators","getDefault","registeredValidators","fields","values","defaults","valuesWithDefaults","Object","keys","map","fieldName","field","validator","_makeValidator","_extractType","value","isEnabled","_isEnabled","fieldOptions","arguments","length","undefined","type","options","validatorOptions","validators","enableWith","optional","optionalIsUndefined","optionalWith","validate","Error","clean","forEach","k","list","assign"],"sources":["../src/schema/utils.js"],"sourcesContent":["'use strict';\n\nconst _ = {\n  get: require('lodash/get'),\n  pick: require('lodash/pick'),\n  isArray: require('lodash/isArray')\n}\n\nconst withFieldValueMatches = require('./withFieldValueMatches');\n\nmodule.exports = {\n  registerValidators,\n  mapValuesToValidators,\n  getDefault\n}\n\nconst registeredValidators = {};\n\nfunction mapValuesToValidators(fields, values, defaults) {\n  const valuesWithDefaults = {\n    ...(defaults || {}),\n    ...values\n  };\n\n  return Object.keys(fields).map(fieldName => ({\n    field: fieldName,\n    validator: _makeValidator(\n      _extractType(_.get(fields, fieldName)),\n      fieldName,\n      _.get(fields, fieldName), // options\n      valuesWithDefaults,\n      fields\n   ),\n    value: _.get(values, fieldName),\n    isEnabled: _isEnabled(valuesWithDefaults, fields, fields[fieldName]),\n  }));\n}\n\n\nfunction _isEnabled(valuesWithDefaults, fields, fieldOptions = {}) {\n  if (!_.get(fieldOptions, 'enableWith')) {\n    return true;\n  }\n\n  if (withFieldValueMatches(fieldOptions, 'enableWith', valuesWithDefaults, fields)) {\n    return true;\n  }\n\n  return false;\n}\n\nfunction _makeValidator(type, field, options, values, fields) {\n  const validatorOptions = {\n    field,\n    ...options\n  };\n\n  if (type === 'list') {\n    validatorOptions.validators = registeredValidators;\n  }\n\n  if (\n    validatorOptions.enableWith &&\n    !withFieldValueMatches(validatorOptions, 'enableWith', values, fields)\n  ) {\n    validatorOptions.optional = true;\n  }\n\n  const optionalIsUndefined = typeof validatorOptions.optional !== 'boolean';\n\n  if (\n    optionalIsUndefined &&\n    validatorOptions.optionalWith &&\n    !withFieldValueMatches(validatorOptions, 'optionalWith', values, fields)\n  ) {\n    validatorOptions.optional = false;\n  } else if (\n    optionalIsUndefined &&\n    validatorOptions.optionalWith\n  ) {\n    validatorOptions.optional = true;\n  }\n\n  const validate = registeredValidators[type](validatorOptions);\n\n  if (typeof validate !== 'function') {\n    throw new Error('There is no registered validator for field type ' + type);\n  }\n\n  return validate;\n}\n\n\nfunction getDefault(fields) {\n  let clean = {};\n\n  Object.keys(fields).forEach(k => {\n    if (fields[k].type === 'schema') {\n      clean[k] = fields[k].list ? [] : getDefault(fields[k].fields);\n    } else {\n      clean[k] = !('default' in fields[k]) ? null : fields[k].default;\n    }\n  });\n\n  return clean;\n}\n\n\nfunction _extractType(fieldOptions) {\n  if (typeof registeredValidators[fieldOptions.type] === 'undefined') {\n    throw new Error('Unregistered type: ' + fieldOptions.type);\n  }\n\n  return fieldOptions.type;\n}\n\n\nfunction registerValidators(validators) {\n  Object.assign(registeredValidators, validators);\n}\n"],"mappings":"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","ignoreList":[]}