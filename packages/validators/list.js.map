{"version":3,"file":"list.js","names":["_","require","formatErrors","module","exports","list","validates","arguments","length","Array","isArray","undefined","config","params","_objectSpread","field","optional","types","validators","Error","forEach","type","concat","push","validateItem","item","decorated","errors","cleanItem","v","err","e","value","validate","cleanOnly","clean","i","errs","extend","index","decorateItem","decorate","map","Object","assign"],"sources":["src/list.js"],"sourcesContent":["const _ = require('lodash');\nconst formatErrors = require('./lib/errors');\n\n/**\n * processes an array of values of potentially different\n * types. Throws a concatenation of all errors with\n * an index.\n */\n\nmodule.exports = function list(...args) {\n  const validates = args.length === 1 && Array.isArray(args[0]) ? args[0] : args[1];\n  const config = args.length === 1 && Array.isArray(args[0]) ? {} : args[0];\n\n  const params = {\n    field: null,\n    optional: true,\n    types: false,\n    validators: false,\n    validates: [],\n    ...config,\n  };\n\n  if (validates) {\n    params.validates = validates;\n  } else {\n    if (!params.types || !params.validators) {\n      throw new Error('if list validators are not given, validators and types must be provided in config');\n    }\n\n    params.types.forEach(type => {\n      if (params.validators[type] === undefined) {\n        throw new Error(`list validator requires ${type} validator to function`);\n      }\n\n      params.validates.push(params.validators[type]());\n    });\n  }\n\n  function validateItem(item, decorated = false) {\n    const errors = [];\n\n    let cleanItem;\n    let type;\n\n    params.validates.forEach(v => {\n      if (cleanItem) return;\n\n      try {\n        type = v.type;\n\n        cleanItem = v(item);\n      } catch (err) {\n        [].concat(err).forEach(e => errors.push(e));\n      }\n    });\n\n    if (cleanItem !== undefined) {\n      return decorated ? {\n        value: cleanItem,\n        type,\n      } : cleanItem;\n    }\n\n    if (decorated) {\n      return {\n        value: item,\n        errors,\n      };\n    }\n\n    throw errors;\n  }\n\n  function validate(value, cleanOnly = false) {\n    const clean = [];\n    const errors = [];\n\n    if (params.optional && !value) {\n      return clean;\n    }\n\n    if (params.optional && _.isArray(value) && !value.length) {\n      return clean;\n    }\n\n    if (Array.isArray(value) && !params.optional && !value.length) {\n      throw formatErrors(params, value, 'required', 'value cannot be empty');\n    }\n\n    if (!_.isArray(value)) {\n      throw formatErrors(params, value, 'list.wrongtype', 'value should be a list');\n    }\n\n    value.forEach((item, i) => {\n      try {\n        clean.push(validateItem(item));\n      } catch (errs) {\n        errs.forEach(e => errors.push(_.extend({}, e, { index: i, field: params.field })));\n      }\n    });\n\n    if (!cleanOnly && errors.length) throw errors;\n\n    return clean;\n  }\n\n  function decorateItem(item) {\n    return validateItem(item, true);\n  }\n\n  function decorate(value) {\n    return (value || []).map(decorateItem);\n  }\n\n  return Object.assign(validate, {\n    type: 'list',\n    field: params.field,\n    clean: v => validate(v, true),\n    decorate,\n    validateItem,\n    decorateItem,\n  });\n};\n"],"mappings":"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","ignoreList":[]}