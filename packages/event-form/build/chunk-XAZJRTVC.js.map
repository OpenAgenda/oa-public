{"version":3,"sources":["../src/components/Location.js"],"sourcesContent":["import _ from 'lodash';\nimport ih from 'immutability-helper';\nimport sa from 'superagent';\nimport { Component } from 'react';\n\nimport { Modal, Spinner } from '@openagenda/react-shared';\nimport LocationSelector from '@openagenda/agenda-locations-app/dist/components/LocationSelector.js';\nimport Provider from '@openagenda/agenda-locations-app/dist/decorators/Providers.js';\n\nimport flattenLocationTagSet from '../utils/flattenLocationTagSet.js';\n\nconst getResItem = (res, key, suffix) => {\n  if (typeof res === 'string') {\n    return res + suffix;\n  }\n  if (res[key]) {\n    return res[key];\n  }\n  return res.default + suffix;\n};\n\nconst getResObject = (res) => ({\n  ...res,\n  index: getResItem(res, 'index', ''),\n  get: getResItem(res, 'get', '/:locationUid'),\n  geocode: getResItem(res, 'geocode', '/geocode'),\n  reverseGeocode: getResItem(res, 'reverse', '/geocode/reverse'),\n  insee: getResItem(res, 'insee', '/insee'),\n  create: getResItem(res, 'create', ''),\n  remove: getResItem(res, 'remove', '/remove'),\n});\n\nclass LocationComponent extends Component {\n  static defaultProps = {\n    location: null,\n    lang: 'en',\n    legacy: {},\n    field: null,\n  };\n\n  constructor(props) {\n    super(props);\n\n    const locationUid = _.get(props, 'value.uid') || _.get(props, 'field.default.uid');\n    const res = getResObject(props.field.res);\n\n    if (!locationUid) {\n      this.state = {\n        mode: 'search',\n        res,\n      };\n    } else {\n      this.state = {\n        initing: true,\n        res,\n      };\n      this.loadLocation(locationUid);\n    }\n\n    this.onChange = this.onChange.bind(this);\n  }\n\n  onChange(mode, location) {\n    const { onChange } = this.props;\n\n    this.setState({ mode });\n\n    onChange(location);\n  }\n\n  getSettings() {\n    const { lang, field } = this.props;\n\n    const settings = {\n      ...field?.legacy ?? {},\n      ...field?.settings ?? {},\n    };\n\n    if (settings.tagSet) {\n      return ih(settings, {\n        tagSet: { $set: flattenLocationTagSet(settings.tagSet, lang) },\n      });\n    }\n\n    return settings;\n  }\n\n  loadLocation(locationUid) {\n    const { res } = this.state;\n\n    const { onChange } = this.props;\n\n    sa.get(res.get.replace(':locationUid', locationUid)).then(\n      (response) => {\n        this.setState({\n          initing: false,\n          mode: response.body ? 'show' : 'search',\n        });\n\n        onChange(response.body);\n      },\n      (err) => {\n        console.log('could not load %s', locationUid);\n        console.log(err);\n\n        this.setState({\n          initing: false,\n          mode: 'search',\n        });\n      },\n    );\n  }\n\n  renderSelector() {\n    const { lang, value, relatedValues, field } = this.props;\n\n    const { mode, res } = this.state;\n\n    const allowRemove = relatedValues?.attendanceMode === 2;\n\n    const {\n      default: defaultValue,\n      tiles,\n      detailedInfo,\n      disableChange,\n      allowCreate,\n      confirmRequired,\n    } = field;\n\n    return (\n      <Provider lang={lang}>\n        <LocationSelector\n          allowCreate={allowCreate}\n          confirmRequired={confirmRequired}\n          tiles={tiles}\n          mode={mode}\n          disableChange={disableChange}\n          detailedInfo={detailedInfo}\n          classNames={{\n            input: '',\n          }}\n          allowRemove={allowRemove}\n          onRemove={() => this.onChange('search', null)}\n          location={_.assign({}, defaultValue || {}, value)}\n          lang={lang}\n          settings={this.getSettings()}\n          res={res}\n          onChange={this.onChange}\n          placeholder={field.placeholder}\n        />\n      </Provider>\n    );\n  }\n\n  render() {\n    const { field } = this.props;\n\n    const { initing, mode } = this.state;\n\n    const spinnerCanvasStyle = {\n      height: 37,\n      position: 'relative',\n    };\n\n    if (initing) {\n      return (\n        <div className=\"margin-v-sm text-center\" style={spinnerCanvasStyle}>\n          <Spinner mode=\"inline\" />\n        </div>\n      );\n    }\n\n    if (['create', 'confirm'].includes(mode)) {\n      return (\n        <div>\n          <div className=\"text-center\" style={spinnerCanvasStyle}>\n            <Spinner mode=\"inline\" />\n          </div>\n          <Modal classNames={{ overlay: 'popup-overlay big' }}>\n            {this.renderSelector()}\n          </Modal>\n        </div>\n      );\n    }\n\n    return (\n      <div>\n        <div className={mode === 'show' ? 'padding-v-sm padding-h-xs' : ''}>\n          {this.renderSelector()}\n        </div>\n        {!field.disableChange && field.sub ? (\n          <div className=\"sub\">{field.sub}</div>\n        ) : null}\n      </div>\n    );\n  }\n}\n\nexport default LocationComponent;\n"],"mappings":"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","names":[]}