{"version":3,"file":"index.js","names":["createAbility","SUBJECT_NAME","createBuilder","rulesLib","middleware","config","init","getEditableRules","ability","entity","entityName","editableRulesGetter","_get","concat","_isFunction","Error","editableRules","map","rule","subject","_objectSpread","conditions","relevantRule","relevantRuleFor","actions","action","isAble","inverted","_assign","_pick","parse","batchUpdate","_ref","collection","table","column","knex","transaction","trx","queries","item","where","update","transacting","_Promise","all","then","commit","catch","rollback","getFormIndex","options","arguments","length","undefined","completeFormFn","neededEntities","identifier","entities","entitiesRules","Object","prototype","hasOwnProperty","call","listEntitiesFn","_isArray","Array","push","apply","list","formIndex","_reduce","accu","identifiers","result","isArray","accu2","result2","defineFn","_find","entityMapping","builder","rules","entityAbility","id","updateFormIndex","data","matchesRule","test","_matches","toCreate","toUpdate","_reduceInstanceProperty","dataRule","schemas","format","batchInsert","returning","get","_isString","TypeError","_isNumber","getEntityFn","entityRules","bind","service","default"],"sources":["../../src/service/index.js"],"sourcesContent":["import _ from 'lodash';\nimport createAbility, { SUBJECT_NAME } from './createAbility.js';\nimport createBuilder from './createBuilder.js';\nimport * as rulesLib from './rules.js';\nimport * as middleware from './middleware.js';\nimport config, { init } from './config.js';\n\nfunction getEditableRules(ability, entity) {\n  const { entityName } = ability;\n\n  if (!entityName) {\n    return [];\n  }\n\n  const editableRulesGetter = _.get(\n    config,\n    `interfaces.editableRules.${entityName}`,\n  );\n\n  if (!_.isFunction(editableRulesGetter)) {\n    throw new Error(`Missing interface \\`editableRules.${entityName}\\``);\n  }\n\n  const editableRules = editableRulesGetter(ability, entity);\n\n  return editableRules.map((rule) => {\n    const subject = { ...rule.conditions, [SUBJECT_NAME]: rule.subject };\n    const relevantRule = ability.relevantRuleFor(\n      rule.actions || rule.action,\n      subject,\n    );\n\n    const isAble = !!relevantRule && !relevantRule.inverted;\n\n    return _.assign(_.pick(rule, 'tag'), rulesLib.parse(rule), {\n      inverted: !isAble,\n      relevantRule: relevantRule ? rulesLib.parse(relevantRule) : relevantRule,\n    });\n  });\n}\n\nfunction batchUpdate({ table, column }, collection) {\n  return config.knex.transaction((trx) => {\n    const queries = collection.map((item) =>\n      config\n        .knex(table)\n        .where(column, item[column])\n        .update(item)\n        .transacting(trx));\n\n    return Promise.all(queries).then(trx.commit).catch(trx.rollback);\n  });\n}\n\nexport async function getFormIndex(ability, options = {}) {\n  const completeFormFn = _.get(\n    config,\n    `interfaces.completeFormIndex.${ability.entityName}`,\n  );\n  const neededEntities = _.isFunction(completeFormFn)\n    ? await completeFormFn(ability, options)\n    : { [ability.entityName]: ability.identifier };\n  const entities = {};\n  const entitiesRules = [];\n\n  for (const entityName in neededEntities) {\n    if (Object.prototype.hasOwnProperty.call(neededEntities, entityName)) {\n      const listEntitiesFn = _.get(\n        config,\n        `interfaces.listEntities.${entityName}`,\n      );\n\n      if (!_.isArray(neededEntities[entityName])) {\n        neededEntities[entityName] = [neededEntities[entityName]];\n      }\n\n      if (!_.isFunction(listEntitiesFn)) {\n        throw new Error(`Missing interface \\`listEntities.${entityName}\\``);\n      }\n\n      entities[entityName] = await listEntitiesFn(neededEntities[entityName]);\n      Array.prototype.push.apply(\n        entitiesRules,\n        await rulesLib.list(entityName, neededEntities[entityName]),\n      );\n    }\n  }\n\n  const formIndex = await _.reduce(\n    neededEntities,\n    async (accu, identifiers, entityName) => {\n      const result = await accu;\n\n      return result.concat(\n        await _.reduce(\n          Array.isArray(identifiers) ? identifiers : [identifiers],\n          async (accu2, identifier) => {\n            const result2 = await accu2;\n\n            // const found = _.find( result2, { entityName, identifier } );\n            //\n            // if ( found ) {\n            //   return result2;\n            // }\n\n            const defineFn = _.get(\n              config,\n              `interfaces.defineFor.${entityName}`,\n            );\n\n            const entity = _.find(entities[entityName], {\n              [config.entityMapping[entityName]]: identifier,\n            });\n            const builder = createBuilder(entityName, identifier);\n            const rules = await defineFn(entity, builder, {\n              rules: entitiesRules,\n            });\n            const entityAbility = createAbility(entityName, identifier, rules);\n\n            return result2.concat(\n              getEditableRules(entityAbility, entity).map((rule) => ({\n                ...rule,\n                id: undefined,\n                entityName,\n                identifier,\n                entity,\n              })),\n            );\n          },\n          [],\n        ),\n      );\n    },\n    [],\n  );\n\n  return formIndex;\n}\n\nexport async function updateFormIndex(ability, data) {\n  const formIndex = await ability.getFormIndex();\n  const matchesRule = (test) =>\n    _.matches(\n      _.pick(\n        test,\n        'entityName',\n        'identifier',\n        'actions',\n        'subject',\n        'conditions',\n      ),\n    );\n\n  const { toCreate, toUpdate } = formIndex.reduce(\n    (result, rule) => {\n      const dataRule = _.find(data, matchesRule(rule));\n\n      if (!dataRule) {\n        return result;\n      }\n\n      if (rule.relevantRule && matchesRule(rule)(rule.relevantRule)) {\n        if (dataRule.inverted !== rule.relevantRule.inverted) {\n          result.toUpdate.push({\n            ...rule,\n            id: rule.relevantRule.id,\n            inverted: !!dataRule.inverted,\n          });\n        }\n      } else {\n        result.toCreate.push({\n          ...rule,\n          inverted: !!dataRule.inverted,\n        });\n      }\n\n      return result;\n    },\n    { toCreate: [], toUpdate: [] },\n  );\n\n  await Promise.all([\n    toUpdate.length\n      ? batchUpdate(\n        { table: config.schemas.rule, column: 'id' },\n        rulesLib.format(toUpdate),\n      )\n      : null,\n    toCreate.length\n      ? config.knex\n        .batchInsert(config.schemas.rule, rulesLib.format(toCreate))\n        .returning('id')\n      : null,\n  ]);\n\n  return ability.getFormIndex();\n}\n\nexport async function get(entityName, identifier, options = {}) {\n  if (!_.isString(entityName)) {\n    throw new TypeError('`entityName` should be a string');\n  }\n\n  if (!_.isNumber(identifier)) {\n    throw new TypeError('`identifier` should be a number');\n  }\n\n  const getEntityFn = _.get(config, `interfaces.getEntity.${entityName}`);\n  const defineFn = _.get(config, `interfaces.defineFor.${entityName}`);\n\n  if (!_.isFunction(getEntityFn)) {\n    throw new Error(`Missing interface \\`getEntity.${entityName}\\``);\n  }\n\n  if (!_.isFunction(defineFn)) {\n    throw new Error(`Missing interface \\`defineFor.${entityName}\\``);\n  }\n\n  const builder = createBuilder(entityName, identifier);\n  const entity = options && options.entity ? options.entity : await getEntityFn(identifier);\n  const entityRules = await defineFn(entity, builder, options);\n  const ability = createAbility(entityName, identifier, entityRules);\n\n  ability.entity = entity;\n  ability.getFormIndex = getFormIndex.bind(null, ability);\n  ability.updateFormIndex = updateFormIndex.bind(null, ability);\n\n  return ability;\n}\n\nconst service = {\n  init,\n  config,\n  get,\n  getFormIndex,\n  updateFormIndex,\n  rules: rulesLib,\n  createAbility,\n  createBuilder,\n};\n\nservice.middleware = {\n  getFormIndex: middleware.getFormIndex.bind(null, service),\n  updateFormIndex: middleware.updateFormIndex.bind(null, service),\n};\n\nexport default service;\nexport { middleware, rulesLib as rules, createAbility, createBuilder };\nexport { default as config, init } from './config.js';\n"],"mappings":"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","ignoreList":[]}