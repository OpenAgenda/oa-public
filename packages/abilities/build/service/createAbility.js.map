{"version":3,"file":"createAbility.js","names":["abilityPkg","Rule","rulesLib","Ability","SUBJECT_NAME","Symbol","getSubjectName","subject","Type","constructor","modelName","name","checkWrapper","func","action","subjectName","conditionsOrSubject","field","haveSubjectProp","isObject","_isObject","undefined","result","createAbility","entityName","identifier","rules","ability","parse","RuleType","can","_wrap","bind","cannot"],"sources":["../../src/service/createAbility.js"],"sourcesContent":["import _ from 'lodash';\nimport abilityPkg from '@casl/ability';\nimport Rule from './Rule.js';\nimport * as rulesLib from './rules.js';\n\nconst { Ability } = abilityPkg;\n\nexport const SUBJECT_NAME = Symbol(\n  '@openagenda/abilities/Ability:SUBJECT_NAME',\n);\n\nfunction getSubjectName(subject) {\n  if (subject && subject[SUBJECT_NAME]) {\n    return subject[SUBJECT_NAME];\n  }\n\n  if (!subject || typeof subject === 'string') {\n    return subject;\n  }\n\n  const Type = typeof subject === 'object' ? subject.constructor : subject;\n\n  return Type.modelName || Type.name;\n}\n\nfunction checkWrapper(func, action, subjectName, conditionsOrSubject, field) {\n  let subject = conditionsOrSubject;\n  const haveSubjectProp = subject && !!subject[SUBJECT_NAME];\n  const isObject = _.isObject(subject);\n\n  if (!haveSubjectProp && isObject) {\n    subject[SUBJECT_NAME] = subjectName;\n  } else if (subject === undefined) {\n    subject = {\n      [SUBJECT_NAME]: subjectName,\n    };\n  }\n\n  const result = func(action, subject, field);\n\n  if (!haveSubjectProp && isObject) {\n    delete subject[SUBJECT_NAME];\n  }\n\n  return result;\n}\n\nexport default function createAbility(entityName, identifier, rules) {\n  const ability = new Ability(rulesLib.parse(rules), {\n    subjectName: getSubjectName,\n    RuleType: Rule,\n  });\n\n  ability.can = _.wrap(ability.can.bind(ability), checkWrapper);\n  ability.cannot = _.wrap(ability.cannot.bind(ability), checkWrapper);\n\n  ability.entityName = entityName;\n  ability.identifier = identifier;\n\n  return ability;\n}\n"],"mappings":";;;AACA,OAAOA,UAAU,MAAM,eAAe;AACtC,OAAOC,IAAI,MAAM,WAAW;AAC5B,OAAO,KAAKC,QAAQ,MAAM,YAAY;AAEtC,MAAM;EAAEC;AAAQ,CAAC,GAAGH,UAAU;AAE9B,OAAO,MAAMI,YAAY,GAAGC,MAAM,CAChC,4CACF,CAAC;AAED,SAASC,cAAcA,CAACC,OAAO,EAAE;EAC/B,IAAIA,OAAO,IAAIA,OAAO,CAACH,YAAY,CAAC,EAAE;IACpC,OAAOG,OAAO,CAACH,YAAY,CAAC;EAC9B;EAEA,IAAI,CAACG,OAAO,IAAI,OAAOA,OAAO,KAAK,QAAQ,EAAE;IAC3C,OAAOA,OAAO;EAChB;EAEA,MAAMC,IAAI,GAAG,OAAOD,OAAO,KAAK,QAAQ,GAAGA,OAAO,CAACE,WAAW,GAAGF,OAAO;EAExE,OAAOC,IAAI,CAACE,SAAS,IAAIF,IAAI,CAACG,IAAI;AACpC;AAEA,SAASC,YAAYA,CAACC,IAAI,EAAEC,MAAM,EAAEC,WAAW,EAAEC,mBAAmB,EAAEC,KAAK,EAAE;EAC3E,IAAIV,OAAO,GAAGS,mBAAmB;EACjC,MAAME,eAAe,GAAGX,OAAO,IAAI,CAAC,CAACA,OAAO,CAACH,YAAY,CAAC;EAC1D,MAAMe,QAAQ,GAAGC,SAAA,CAAWb,OAAO,CAAC;EAEpC,IAAI,CAACW,eAAe,IAAIC,QAAQ,EAAE;IAChCZ,OAAO,CAACH,YAAY,CAAC,GAAGW,WAAW;EACrC,CAAC,MAAM,IAAIR,OAAO,KAAKc,SAAS,EAAE;IAChCd,OAAO,GAAG;MACR,CAACH,YAAY,GAAGW;IAClB,CAAC;EACH;EAEA,MAAMO,MAAM,GAAGT,IAAI,CAACC,MAAM,EAAEP,OAAO,EAAEU,KAAK,CAAC;EAE3C,IAAI,CAACC,eAAe,IAAIC,QAAQ,EAAE;IAChC,OAAOZ,OAAO,CAACH,YAAY,CAAC;EAC9B;EAEA,OAAOkB,MAAM;AACf;AAEA,eAAe,SAASC,aAAaA,CAACC,UAAU,EAAEC,UAAU,EAAEC,KAAK,EAAE;EACnE,MAAMC,OAAO,GAAG,IAAIxB,OAAO,CAACD,QAAQ,CAAC0B,KAAK,CAACF,KAAK,CAAC,EAAE;IACjDX,WAAW,EAAET,cAAc;IAC3BuB,QAAQ,EAAE5B;EACZ,CAAC,CAAC;EAEF0B,OAAO,CAACG,GAAG,GAAGC,KAAA,CAAOJ,OAAO,CAACG,GAAG,CAACE,IAAI,CAACL,OAAO,CAAC,EAAEf,YAAY,CAAC;EAC7De,OAAO,CAACM,MAAM,GAAGF,KAAA,CAAOJ,OAAO,CAACM,MAAM,CAACD,IAAI,CAACL,OAAO,CAAC,EAAEf,YAAY,CAAC;EAEnEe,OAAO,CAACH,UAAU,GAAGA,UAAU;EAC/BG,OAAO,CAACF,UAAU,GAAGA,UAAU;EAE/B,OAAOE,OAAO;AAChB","ignoreList":[]}