{"version":3,"file":"AbilitiesEditor.js","names":["useState","useEffect","useCallback","useMemo","Form","setFieldDataMutator","IntlProvider","FormattedMessage","useLatestModule","Spinner","locales","AbilitiesForm","getChildCheckboxDecorator","jsxDEV","_jsxDEV","useLatest","default","uniqueIdCounter","getUniqueId","getInitialValues","rules","_reduceInstanceProperty","call","result","rule","key","inverted","undefined","AbilitiesEditor","_ref","entityName","identifier","locale","filterInputPlaceholder","onSubmit","res","HeaderComponent","searchChildKey","loading","setLoading","data","setData","error","setError","fetchAbilities","response","fetch","concat","formIndex","fetchedData","json","formattedData","map","v","_objectSpread","err","handleSubmit","values","form","method","headers","body","JSON","stringify","responseData","Array","isArray","initialize","latestData","childCheckboxDecorator","getRules","current","renderContent","fileName","_jsxFileName","lineNumber","columnNumber","id","defaultMessage","validateOnBlur","subscription","initialValues","decorators","mutators","setFieldData","component","messages","en","children"],"sources":["../../src/client/AbilitiesEditor.js"],"sourcesContent":["import { useState, useEffect, useCallback, useMemo } from 'react';\nimport { Form } from 'react-final-form';\nimport setFieldDataMutator from 'final-form-set-field-data';\nimport { IntlProvider, FormattedMessage } from 'react-intl';\nimport useLatestModule from 'react-use/lib/useLatest.js';\nimport { Spinner } from '@openagenda/react-shared';\nimport * as locales from '../locales-compiled/index.js';\nimport AbilitiesForm from './AbilitiesForm.js';\nimport getChildCheckboxDecorator from './getChildCheckboxDecorator.js';\n\nconst useLatest = useLatestModule.default || useLatestModule;\n\nlet uniqueIdCounter = 0;\n\nfunction getUniqueId() {\n  uniqueIdCounter += 1;\n  return uniqueIdCounter;\n}\n\nfunction getInitialValues(rules) {\n  return rules.reduce((result, rule) => {\n    result[rule.key] = rule.inverted === undefined ? true : !rule.inverted;\n    return result;\n  }, {});\n}\n\nfunction AbilitiesEditor({\n  entityName,\n  identifier,\n  locale = 'en',\n  filterInputPlaceholder = '',\n  onSubmit,\n  res,\n  HeaderComponent,\n  searchChildKey,\n}) {\n  const [loading, setLoading] = useState(true);\n  const [data, setData] = useState(null);\n  const [error, setError] = useState(null);\n\n  const fetchAbilities = useCallback(async () => {\n    setLoading(true);\n    try {\n      const response = await fetch(\n        `${res.formIndex}?entityName=${entityName}&identifier=${identifier}`,\n      );\n      const fetchedData = await response.json();\n      const formattedData = fetchedData.map((v) => ({\n        ...v,\n        key: `rule${getUniqueId()}`,\n      }));\n      setData(formattedData);\n      setError(null);\n    } catch (err) {\n      setError(err);\n    } finally {\n      setLoading(false);\n    }\n  }, [res.formIndex, entityName, identifier]);\n\n  useEffect(() => {\n    fetchAbilities();\n  }, [fetchAbilities]);\n\n  const handleSubmit = async (values, form) => {\n    const formIndex = data.map((rule) => ({\n      ...rule,\n      inverted: !values[rule.key],\n    }));\n\n    if (typeof onSubmit === 'function') {\n      return onSubmit(formIndex);\n    }\n\n    try {\n      const response = await fetch(\n        `${res.formIndex}?entityName=${entityName}&identifier=${identifier}`,\n        {\n          method: 'PATCH',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify(formIndex),\n        },\n      );\n      const responseData = await response.json();\n      if (Array.isArray(responseData)) {\n        const formattedData = responseData.map((v) => ({\n          ...v,\n          key: `rule${getUniqueId()}`,\n        }));\n        setData(formattedData);\n        form.initialize(getInitialValues(formattedData));\n      }\n    } catch (err) {\n      setError(err);\n    }\n  };\n\n  const latestData = useLatest(data);\n  const childCheckboxDecorator = useMemo(\n    () =>\n      getChildCheckboxDecorator({\n        entityName,\n        identifier,\n        getRules: () => latestData.current,\n      }),\n    [latestData, entityName, identifier],\n  );\n\n  const renderContent = () => {\n    if (loading) return <Spinner />;\n    if (error) {\n      return (\n        <FormattedMessage\n          id=\"Abilities.AbilitiesEditor.error\"\n          defaultMessage=\"Error.\"\n        />\n      );\n    }\n\n    return (\n      <Form\n        validateOnBlur\n        subscription={{}}\n        initialValues={getInitialValues(data)}\n        onSubmit={handleSubmit}\n        decorators={[childCheckboxDecorator]}\n        mutators={{ setFieldData: setFieldDataMutator }}\n        component={AbilitiesForm}\n        rules={data}\n        entityName={entityName}\n        identifier={identifier}\n        HeaderComponent={HeaderComponent}\n        searchChildKey={searchChildKey}\n        filterInputPlaceholder={filterInputPlaceholder}\n      />\n    );\n  };\n\n  // eslint-disable-next-line import/namespace\n  const messages = locales[locale] || locales.en;\n  return (\n    <IntlProvider locale={locale} messages={messages}>\n      {renderContent()}\n    </IntlProvider>\n  );\n}\n\nexport default AbilitiesEditor;\n"],"mappings":"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","ignoreList":[]}