{"version":3,"file":"getChildCheckboxDecorator.js","names":["createDecorator","_ref","entityName","identifier","getRules","form","mutators","setFieldData","getState","getFieldState","field","updates","value","allValues","rules","firstEntityRules","otherRules","_partition","_matches","concernedRule","find","v","key","relatedRules","_filter","_pick","formState","fieldState","pristine","initial","dirtySinceLastSubmit","_isMatch","data","indeterminate","length","every","rule","_reduceInstanceProperty","call","result","relatedFirstRule","_find"],"sources":["../../src/client/getChildCheckboxDecorator.js"],"sourcesContent":["import _ from 'lodash';\nimport createDecorator from 'final-form-calculate';\n\nexport default ({ entityName, identifier, getRules }) =>\n  (form) => {\n    const {\n      mutators: { setFieldData },\n      getState,\n      getFieldState,\n    } = form;\n\n    return createDecorator({\n      field: /rule\\d+/,\n      updates: (value, field, allValues) => {\n        const rules = getRules();\n        const [firstEntityRules, otherRules] = _.partition(\n          rules,\n          _.matches({\n            entityName,\n            identifier,\n          }),\n        );\n        const concernedRule = rules.find((v) => v.key === field);\n        const relatedRules = _.filter(\n          otherRules,\n          _.matches(_.pick(concernedRule, 'actions', 'subject', 'conditions')),\n        );\n\n        const formState = getState();\n        const fieldState = getFieldState(field);\n\n        if (\n          formState.pristine\n          && fieldState.initial\n          && fieldState.dirtySinceLastSubmit\n        ) {\n          return {};\n        }\n\n        if (_.isMatch(concernedRule, { entityName, identifier })) {\n          // when UNcheck an indeterminate checkbox OR all related rules are checked\n          if (\n            fieldState.data.indeterminate\n            || (relatedRules.length\n              && relatedRules.every((rule) => allValues[rule.key] === true))\n          ) {\n            return relatedRules.reduce(\n              (result, rule) => {\n                if (allValues[rule.key] !== false) {\n                  result[rule.key] = false;\n                }\n\n                return result;\n              },\n              { [field]: false },\n            );\n          }\n\n          if (value) {\n            return relatedRules.reduce((result, rule) => {\n              if (allValues[rule.key] !== true) {\n                result[rule.key] = true;\n              }\n\n              return result;\n            }, {});\n          }\n\n          return {};\n        }\n\n        const relatedFirstRule = _.find(\n          firstEntityRules,\n          _.matches(_.pick(concernedRule, 'actions', 'subject', 'conditions')),\n        );\n\n        if (relatedFirstRule && allValues[relatedFirstRule.key]) {\n          setFieldData(relatedFirstRule.key, { indeterminate: true });\n        }\n\n        return {};\n      },\n    })(form);\n  };\n"],"mappings":"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","ignoreList":[]}