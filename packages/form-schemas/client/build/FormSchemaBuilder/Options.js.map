{"version":3,"file":"Options.js","names":["ih","useState","useCallback","DndContext","closestCenter","KeyboardSensor","PointerSensor","useSensor","useSensors","SortableContext","sortableKeyboardCoordinates","verticalListSortingStrategy","restrictToVerticalAxis","dragAndDrop","makeLabelGetter","labels","OptionLabelsForm","OptionItem","jsxDEV","_jsxDEV","arrayMove","getLabel","modes","ADDING","EDITING","Options","_ref","field","value","lang","onChange","mode","setMode","_field$devInitState$m","_field$devInitState","devInitState","editedIndex","setEditedIndex","_field$devInitState$e","_field$devInitState2","sensors","activationConstraint","distance","coordinateGetter","getOptions","addOption","newOption","concat","editOption","index","removeOption","$splice","updateOption","option","options","optionWithId","_assign","id","_set","isOptionActionable","_context","_includesInstanceProperty","call","isOptionDisabled","renderAdd","_context2","type","disabled","className","onClick","children","fileName","_jsxFileName","lineNumber","columnNumber","otherOptions","onSubmit","i","o","languages","_isArray","labelLanguages","length","renderDraggableOptions","collisionDetection","modifiers","onDragEnd","event","active","over","mapped","map","oldIndex","indexOf","newIndex","items","strategy","filter","isEdited","actionable","onEdit","onEditCancel","onRemove","onUpdate","disableDnD"],"sources":["../../src/FormSchemaBuilder/Options.js"],"sourcesContent":["import _ from 'lodash';\nimport ih from 'immutability-helper';\nimport { useState, useCallback } from 'react';\n\nimport {\n  DndContext,\n  closestCenter,\n  KeyboardSensor,\n  PointerSensor,\n  useSensor,\n  useSensors,\n} from '@dnd-kit/core';\n\nimport {\n  SortableContext,\n  sortableKeyboardCoordinates,\n  verticalListSortingStrategy,\n} from '@dnd-kit/sortable';\n\nimport { restrictToVerticalAxis } from '@dnd-kit/modifiers';\n\nimport { dragAndDrop } from '@openagenda/react-shared';\n\nimport makeLabelGetter from '@openagenda/labels/makeLabelGetter.js';\n\nimport labels from './lib/labels.js';\nimport OptionLabelsForm from './OptionLabelsForm.js';\nimport OptionItem from './OptionItem.js';\n\nconst { arrayMove } = dragAndDrop;\n\nconst getLabel = makeLabelGetter(labels);\n\nconst modes = {\n  ADDING: 0,\n  EDITING: 1,\n};\n\nconst Options = ({ field, value, lang, onChange }) => {\n  const [mode, setMode] = useState(() => field.devInitState?.mode ?? null);\n  const [editedIndex, setEditedIndex] = useState(\n    () => field.devInitState?.editedIndex ?? null,\n  );\n\n  const sensors = useSensors(\n    useSensor(PointerSensor, {\n      activationConstraint: {\n        distance: 8,\n      },\n    }),\n    useSensor(KeyboardSensor, {\n      coordinateGetter: sortableKeyboardCoordinates,\n    }),\n  );\n\n  const getOptions = useCallback(() => value || [], [value]);\n\n  const addOption = useCallback(\n    (newOption) => {\n      onChange(getOptions().concat(newOption));\n    },\n    [getOptions, onChange],\n  );\n\n  const editOption = useCallback((index) => {\n    setMode(modes.EDITING);\n    setEditedIndex(index);\n  }, []);\n\n  const removeOption = useCallback(\n    (index) => {\n      onChange(ih(getOptions(), { $splice: [[index, 1]] }));\n    },\n    [getOptions, onChange],\n  );\n\n  const updateOption = useCallback(\n    (index, option) => {\n      const options = getOptions();\n      const optionWithId = _.assign({ id: options[index].id }, option);\n      onChange(_.set(options, index, optionWithId));\n      setMode(null);\n    },\n    [getOptions, onChange],\n  );\n\n  const isOptionActionable = useCallback(\n    () => ![modes.EDITING].includes(mode),\n    [mode],\n  );\n\n  const isOptionDisabled = useCallback(\n    (index) => {\n      if (mode === modes.ADDING) return false;\n      if (mode === modes.EDITING && index !== editedIndex) return true;\n      return false;\n    },\n    [mode, editedIndex],\n  );\n\n  const renderAdd = () => {\n    if (![modes.ADDING].includes(mode)) {\n      return (\n        <button\n          type=\"button\"\n          disabled={mode !== null}\n          className=\"btn btn-primary margin-top-md\"\n          onClick={() => setMode(modes.ADDING)}\n        >\n          {getLabel('optionAdd', lang)}\n        </button>\n      );\n    }\n\n    if (mode === modes.ADDING) {\n      return (\n        <div className=\"margin-top-md\">\n          <OptionLabelsForm\n            otherOptions={getOptions()}\n            onSubmit={(i, o) => addOption(o)}\n            lang={lang}\n            languages={\n              _.isArray(field.labelLanguages) && field.labelLanguages.length\n                ? field.labelLanguages\n                : null\n            }\n          />\n        </div>\n      );\n    }\n  };\n\n  const renderDraggableOptions = () => {\n    const options = getOptions();\n\n    return (\n      <DndContext\n        sensors={sensors}\n        collisionDetection={closestCenter}\n        modifiers={[restrictToVerticalAxis]}\n        onDragEnd={(event) => {\n          const { active, over } = event;\n          if (active.id !== over.id) {\n            const mapped = options.map((o) => o.value);\n            const oldIndex = mapped.indexOf(active.id);\n            const newIndex = mapped.indexOf(over.id);\n            onChange(arrayMove(options, oldIndex, newIndex));\n          }\n        }}\n      >\n        <SortableContext\n          items={options.map((o) => o.value)}\n          strategy={verticalListSortingStrategy}\n        >\n          <div className=\"list-group margin-v-sm\">\n            {options.map((option, index) => (\n              <OptionItem\n                lang={lang}\n                field={field}\n                option={option}\n                otherOptions={value.filter((o, i) => i !== index)}\n                index={index}\n                isEdited={mode === modes.EDITING && index === editedIndex}\n                actionable={isOptionActionable()}\n                disabled={isOptionDisabled(index)}\n                onEdit={(i) => editOption(i)}\n                onEditCancel={() => setMode(null)}\n                onRemove={() => removeOption(index)}\n                onUpdate={(i, o) => updateOption(i, o)}\n                key={option.value}\n                disableDnD={mode === modes.EDITING}\n              />\n            ))}\n          </div>\n        </SortableContext>\n      </DndContext>\n    );\n  };\n\n  const options = getOptions();\n\n  return (\n    <div className=\"options-field-form dnd\">\n      {options.length\n        ? renderDraggableOptions()\n        : (\n          <div className=\"margin-top-md margin-bottom-sm text-center\">\n            {getLabel('emptyOptions', lang)}\n          </div>\n        )}\n      {renderAdd()}\n    </div>\n  );\n};\n\nexport default Options;\n"],"mappings":"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","ignoreList":[]}