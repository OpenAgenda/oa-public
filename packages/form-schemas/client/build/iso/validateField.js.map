{"version":3,"file":"validateField.js","names":["choice","schema","passValidator","textValidator","booleanValidator","linkValidator","emailValidator","phoneValidator","numberValidator","dateValidator","multilingualValidator","integerValidator","areLabelsMultilingual","getWithFieldName","optionedTypes","minMaxedTypes","multilingualTypes","buildFieldSchema","types","typeKeys","Object","keys","register","pass","text","boolean","link","email","phone","number","date","multilingual","integer","validateStandardType","optional","options","default","unique","stripUndefinedSchemaFields","fieldSchema","value","_context","_reduceInstanceProperty","call","stripped","key","undefined","_set","validateType","_context2","custom","arguments","length","dirtyType","_get","_includesInstanceProperty","validate","_context3","requireLabels","type","isCustomField","isAbstract","errors","defaultLabelLanguage","isMultilingual","clean","enableWith","_context4","fieldName","concat","optionalWith","_context5","forEach","_context6","u","v","field","code","message","origin","min","max","_isArray","languages","fieldType"],"sources":["../../src/iso/validateField.js"],"sourcesContent":["import _ from 'lodash';\nimport choice from '@openagenda/validators/choice.js';\nimport schema from '@openagenda/validators/schema/index.js';\nimport passValidator from '@openagenda/validators/pass.js';\nimport textValidator from '@openagenda/validators/text.js';\nimport booleanValidator from '@openagenda/validators/boolean.js';\nimport linkValidator from '@openagenda/validators/link.js';\nimport emailValidator from '@openagenda/validators/email.js';\nimport phoneValidator from '@openagenda/validators/phone.js';\nimport numberValidator from '@openagenda/validators/number.js';\nimport dateValidator from '@openagenda/validators/date.js';\nimport multilingualValidator from '@openagenda/validators/multilingual.js';\nimport integerValidator from '@openagenda/validators/integer.js';\nimport areLabelsMultilingual from './areLabelsMultilingual.js';\nimport getWithFieldName from './getWithFieldName.js';\nimport {\n  optionedTypes,\n  minMaxedTypes,\n  multilingualTypes,\n} from './fieldTypes.js';\nimport buildFieldSchema from './buildFieldSchema.js';\nimport types from './types.js';\n\nconst typeKeys = Object.keys(types);\n\nschema.register({\n  pass: passValidator,\n  text: textValidator,\n  boolean: booleanValidator,\n  link: linkValidator,\n  email: emailValidator,\n  phone: phoneValidator,\n  number: numberValidator,\n  date: dateValidator,\n  multilingual: multilingualValidator,\n  integer: integerValidator,\n  choice,\n});\n\nconst validateStandardType = choice({\n  optional: false,\n  options: typeKeys,\n  default: 'text',\n  unique: true,\n});\n\nconst stripUndefinedSchemaFields = (fieldSchema, value) =>\n  Object.keys(fieldSchema).reduce(\n    (stripped, key) =>\n      (value[key] !== undefined\n        ? _.set(stripped, key, fieldSchema[key])\n        : stripped),\n    {},\n  );\n\nfunction validateType(value, custom = {}) {\n  const dirtyType = _.get(value, 'fieldType', 'abstract');\n\n  if (custom && Object.keys(custom).includes(dirtyType)) {\n    return dirtyType;\n  }\n\n  return validateStandardType(dirtyType);\n}\n\n/**\n * completes schema validation with rules not handled\n * by validation library:\n *\n *  * an option value must be unique within its group\n *  * a max cannot be smaller than a min (when set)\n */\nfunction validate(value, options = {}) {\n  const custom = _.get(options, 'custom', {});\n  const requireLabels = _.get(options, 'requireLabels', true);\n\n  const type = validateType(value, custom);\n\n  const isCustomField = Object.keys(custom || {}).includes(type);\n  const isAbstract = type === 'abstract';\n\n  let errors = [];\n\n  const fieldSchema = buildFieldSchema(isCustomField ? 'custom' : type, {\n    defaultLabelLanguage: options.defaultLabelLanguage,\n    isMultilingual: areLabelsMultilingual(value),\n    requireLabels,\n  });\n\n  const clean = schema(\n    isAbstract ? stripUndefinedSchemaFields(fieldSchema, value) : fieldSchema,\n  )(value);\n\n  // enableWith tells validator it is active if field specified has a value.\n  // if set, the field must be part of related fields\n  if (clean.enableWith) {\n    const fieldName = getWithFieldName(clean.enableWith);\n    if (!_.get(clean, 'related.enable', []).includes(fieldName)) {\n      _.set(\n        clean,\n        'related.enable',\n        _.get(clean, 'related.enable', []).concat(fieldName),\n      );\n    }\n  }\n\n  if (clean.optionalWith) {\n    const fieldName = getWithFieldName(clean.optionalWith);\n    if (!_.get(clean, 'related.optional', []).includes(fieldName)) {\n      _.set(\n        clean,\n        'related.optional',\n        _.get(clean, 'related.optional', []).concat(fieldName),\n      );\n    }\n  }\n\n  // if is custom or abstract field, do not filter out remaining values\n  if (isCustomField || isAbstract) {\n    Object.keys(value || {}).forEach((key) => {\n      clean[key] = value[key];\n    });\n  }\n\n  // validate any optioned type\n  if (optionedTypes.includes(type)) {\n    const unique = _.get(value, 'options', []).reduce(\n      (u, v) => (!u.includes(v.value) ? u.concat(v.value) : u),\n      [],\n    );\n\n    if (unique.length !== _.get(value, 'options', []).length) {\n      errors = errors.concat({\n        field: 'options',\n        code: 'duplicate',\n        message: 'option values must be unique',\n        origin: value,\n      });\n    }\n  }\n\n  // validate any\n  if (\n    (minMaxedTypes.includes(type) || isCustomField)\n    && value.min !== undefined\n    && value.max !== undefined\n  ) {\n    if (value.max < value.min) {\n      errors = errors.concat({\n        field: 'max',\n        code: 'smallerthan.min',\n        message: 'max cannot be smaller than min',\n        origin: value,\n      });\n    }\n  }\n\n  if (multilingualTypes.includes(type) && _.isArray(value.languages)) {\n    clean.languages = value.languages;\n  }\n\n  if (errors.length) throw errors;\n\n  clean.fieldType = type;\n\n  return clean;\n}\n\nexport default validate;\n"],"mappings":"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","ignoreList":[]}