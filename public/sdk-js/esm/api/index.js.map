{"version":3,"file":"index.js","names":["axios","qs","Events","Locations","reduceAccessToken","getNonce","OaSdk","constructor","options","_defineProperty","params","_merge","publicKey","secretKey","accessToken","expiresIn","api","create","baseURL","process","env","NODE_ENV","paramsSerializer","stringify","interceptors","request","use","config","skipRefreshToken","refreshToken","skipAccessToken","headers","_objectSpread","skipNonce","nonce","reducedAccessToken","requestTokenTime","skipPublicKey","method","key","connect","time","Date","getTime","response","post","code","data","access_token","expires_in","tokenIsExpired"],"sources":["../../src/api/index.js"],"sourcesContent":["import _ from 'lodash';\nimport axios from 'axios';\nimport qs from 'qs';\nimport Events from './Events';\nimport Locations from './Locations';\nimport reduceAccessToken from './utils/reduceAccessToken';\nimport getNonce from './utils/getNonce';\n\nexport default class OaSdk {\n  constructor(options) {\n    this.params = _.merge(\n      {\n        publicKey: null,\n        secretKey: null,\n      },\n      options,\n    );\n\n    this.accessToken = null;\n    this.expiresIn = null;\n\n    this.api = axios.create({\n      baseURL:\n        process.env.NODE_ENV !== 'development'\n          ? 'https://api.openagenda.com/v2'\n          : 'https://dapi.openagenda.com/v2',\n      paramsSerializer: qs.stringify,\n    });\n\n    this.api.interceptors.request.use(async (config) => {\n      if (!config.skipRefreshToken && this.params.secretKey) {\n        await this.refreshToken();\n      }\n\n      if (!config.skipAccessToken && this.accessToken) {\n        config.headers = {\n          'access-token': this.accessToken,\n          ...config.headers,\n        };\n      }\n\n      if (!config.skipNonce && this.accessToken) {\n        config.headers = {\n          nonce: getNonce(this.reducedAccessToken, this.requestTokenTime),\n          ...config.headers,\n        };\n      }\n\n      if (\n        !config.skipPublicKey\n        && config.method === 'get'\n        && !this.accessToken\n      ) {\n        config.params = {\n          key: this.params.publicKey,\n          ...config.params,\n        };\n      }\n\n      return config;\n    });\n  }\n\n  events = new Events(this);\n\n  locations = new Locations(this);\n\n  async connect(secretKey) {\n    const time = new Date().getTime();\n\n    if (!this.params.secretKey) {\n      this.params.secretKey = secretKey;\n    }\n\n    const response = await this.api.post(\n      '/requestAccessToken',\n      {\n        'grant-type': 'authorization_code',\n        code: secretKey || this.params.secretKey,\n      },\n      {\n        skipRefreshToken: true, // avoid loop\n      },\n    );\n\n    this.accessToken = response.data.access_token;\n    this.expiresIn = response.data.expires_in;\n    this.requestTokenTime = time;\n\n    this.reducedAccessToken = reduceAccessToken(this.accessToken);\n\n    return response;\n  }\n\n  async refreshToken() {\n    if (this.tokenIsExpired()) {\n      await this.connect();\n    }\n  }\n\n  tokenIsExpired() {\n    if (!this.accessToken) {\n      return true;\n    }\n\n    return new Date().getTime() > this.requestTokenTime + this.expiresIn * 1000;\n  }\n}\n"],"mappings":"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","ignoreList":[]}