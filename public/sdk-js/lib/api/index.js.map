{"version":3,"file":"index.js","names":["_axios","_interopRequireDefault","require","_qs","_Events","_Locations","_reduceAccessToken","_getNonce","OaSdk","constructor","options","_defineProperty2","default","Events","Locations","params","_merge2","publicKey","secretKey","accessToken","expiresIn","api","axios","create","baseURL","process","env","NODE_ENV","paramsSerializer","qs","stringify","interceptors","request","use","config","skipRefreshToken","refreshToken","skipAccessToken","headers","_objectSpread2","skipNonce","nonce","getNonce","reducedAccessToken","requestTokenTime","skipPublicKey","method","key","connect","time","Date","getTime","response","post","code","data","access_token","expires_in","reduceAccessToken","tokenIsExpired","exports","module"],"sources":["../../src/api/index.js"],"sourcesContent":["import _ from 'lodash';\nimport axios from 'axios';\nimport qs from 'qs';\nimport Events from './Events';\nimport Locations from './Locations';\nimport reduceAccessToken from './utils/reduceAccessToken';\nimport getNonce from './utils/getNonce';\n\nexport default class OaSdk {\n  constructor(options) {\n    this.params = _.merge(\n      {\n        publicKey: null,\n        secretKey: null,\n      },\n      options,\n    );\n\n    this.accessToken = null;\n    this.expiresIn = null;\n\n    this.api = axios.create({\n      baseURL:\n        process.env.NODE_ENV !== 'development'\n          ? 'https://api.openagenda.com/v2'\n          : 'https://dapi.openagenda.com/v2',\n      paramsSerializer: qs.stringify,\n    });\n\n    this.api.interceptors.request.use(async (config) => {\n      if (!config.skipRefreshToken && this.params.secretKey) {\n        await this.refreshToken();\n      }\n\n      if (!config.skipAccessToken && this.accessToken) {\n        config.headers = {\n          'access-token': this.accessToken,\n          ...config.headers,\n        };\n      }\n\n      if (!config.skipNonce && this.accessToken) {\n        config.headers = {\n          nonce: getNonce(this.reducedAccessToken, this.requestTokenTime),\n          ...config.headers,\n        };\n      }\n\n      if (\n        !config.skipPublicKey\n        && config.method === 'get'\n        && !this.accessToken\n      ) {\n        config.params = {\n          key: this.params.publicKey,\n          ...config.params,\n        };\n      }\n\n      return config;\n    });\n  }\n\n  events = new Events(this);\n\n  locations = new Locations(this);\n\n  async connect(secretKey) {\n    const time = new Date().getTime();\n\n    if (!this.params.secretKey) {\n      this.params.secretKey = secretKey;\n    }\n\n    const response = await this.api.post(\n      '/requestAccessToken',\n      {\n        'grant-type': 'authorization_code',\n        code: secretKey || this.params.secretKey,\n      },\n      {\n        skipRefreshToken: true, // avoid loop\n      },\n    );\n\n    this.accessToken = response.data.access_token;\n    this.expiresIn = response.data.expires_in;\n    this.requestTokenTime = time;\n\n    this.reducedAccessToken = reduceAccessToken(this.accessToken);\n\n    return response;\n  }\n\n  async refreshToken() {\n    if (this.tokenIsExpired()) {\n      await this.connect();\n    }\n  }\n\n  tokenIsExpired() {\n    if (!this.accessToken) {\n      return true;\n    }\n\n    return new Date().getTime() > this.requestTokenTime + this.expiresIn * 1000;\n  }\n}\n"],"mappings":"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","ignoreList":[]}