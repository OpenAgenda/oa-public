{"version":3,"sources":["../src/components/filters/CustomFilter.js"],"sourcesContent":["import React, { useCallback, useEffect, useMemo, useRef } from 'react';\nimport { useForm, FormSpy } from 'react-final-form';\nimport a11yButtonActionHandler from '@openagenda/react-shared/dist/utils/a11yButtonActionHandler.js';\nimport matchQuery from '../../utils/matchQuery.js';\nimport updateFormValues from '../../utils/updateFormValues.js';\nimport updateCustomFilter from '../../utils/updateCustomFilter.js';\nimport FilterPreviewer from '../FilterPreviewer.js';\n\nconst subscription = { values: true };\n\nfunction Preview({\n  name,\n  component = FilterPreviewer,\n  disabled,\n  activeFilterLabel,\n  filter,\n  query,\n  ...rest\n}) {\n  const form = useForm();\n\n  const onRemove = useCallback(\n    (e) => {\n      e.stopPropagation();\n\n      if (disabled) {\n        return;\n      }\n\n      updateFormValues(form, filter.query, false);\n    },\n    [disabled, form, filter],\n  );\n\n  return (\n    <FormSpy subscription={subscription}>\n      {({ values }) => {\n        if (!matchQuery(values, query) || !activeFilterLabel) {\n          return null;\n        }\n\n        return React.createElement(component, {\n          name,\n          label: activeFilterLabel,\n          onRemove,\n          disabled,\n          filter,\n          ...rest,\n        });\n      }}\n    </FormSpy>\n  );\n}\n\nfunction CustomFilter({ filter }) {\n  const form = useForm();\n  const firstRender = useRef(true);\n\n  const updateForm = useCallback(\n    (e) => {\n      e.preventDefault();\n      e.stopPropagation();\n\n      const query = form.getState().values;\n\n      updateFormValues(form, filter.query, !matchQuery(query, filter.query));\n    },\n    [filter.query, form],\n  );\n\n  const onChange = useMemo(\n    () => a11yButtonActionHandler(updateForm),\n    [updateForm],\n  );\n\n  useEffect(() => {\n    if (firstRender.current) {\n      firstRender.current = false;\n\n      const query = form.getState().values;\n      const matchInitialQuery = matchQuery(query, filter.query);\n      const registeredFields = form.getRegisteredFields();\n\n      for (const key in filter.query) {\n        if (Object.prototype.hasOwnProperty.call(filter.query, key)) {\n          if (!registeredFields.includes(key)) {\n            form.registerField(\n              key,\n              () => {},\n              { value: true },\n              {\n                initialValue: matchInitialQuery ? filter.query[key] : undefined,\n              },\n            );\n          }\n        }\n      }\n    }\n\n    const handlerElem = filter.handlerElem || filter.elem;\n    const innerCheckboxes = handlerElem.querySelectorAll(\n      'input[type=\"checkbox\"]',\n    );\n\n    const handlerIsLabelWithCheckbox = innerCheckboxes.length === 1\n      && handlerElem.tagName === 'LABEL'\n      && handlerElem.contains(innerCheckboxes[0]);\n\n    if (\n      innerCheckboxes.length === 1\n      && (!filter.handlerElem || handlerIsLabelWithCheckbox)\n    ) {\n      innerCheckboxes[0].addEventListener('change', updateForm, false);\n    } else {\n      handlerElem.addEventListener('click', onChange, false);\n    }\n\n    handlerElem.addEventListener('keydown', onChange, false);\n\n    const unsubscribe = form.subscribe(\n      ({ values }) =>\n        updateCustomFilter(filter, matchQuery(values, filter.query)),\n      { values: true },\n    );\n\n    return () => {\n      if (\n        innerCheckboxes.length === 1\n        && (!filter.handlerElem || handlerIsLabelWithCheckbox)\n      ) {\n        innerCheckboxes[0].removeEventListener('change', updateForm, false);\n      } else {\n        handlerElem.removeEventListener('click', onChange, false);\n      }\n\n      handlerElem.removeEventListener('keydown', onChange, false);\n\n      unsubscribe();\n    };\n  }, [filter, form, onChange, updateForm]);\n\n  return null;\n}\n\nconst exported = React.memo(CustomFilter);\n\n// React.memo lose statics\nexported.Preview = Preview;\n\nexport default exported;\n"],"mappings":"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","names":[]}